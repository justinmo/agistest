/**
 * <pre>
 * 
 *  Accela GIS
 *  BusinessHandler.js
 * 
 *  Accela, Inc.
 *  Copyright (C): 2014
 * 
 *  Description:
 * 
 *  Note
 *  Created By: Iron Tang
 *
 * <Date>       <Who>       <What>
 * 6/30/2014     Iron Tang    init
 *
 * </pre>
 */
define(["dojo/Evented","dojo/parser","dojo/on","dojo/_base/declare","dojo/dom-construct","esri/InfoWindowBase","dojo/dom-class","dojo/fx/Toggler","dojo/dom-style","dojo/_base/lang","dojo/fx","esri/domUtils","dojo/topic","dojo/dom-geometry","esri/geometry/Point","esri/geometry/ScreenPoint","dojo/ready"],function(q,a,m,i,f,g,p,d,k,b,h,e,j,n,l,c,o){return i([g,q],{titlePanel:null,contentPanel:null,backData:null,backButton:null,closeButton:null,showScreenPoint:null,showMapPoint:null,isEnabled:true,centerScreen:null,isPaning:false,topScrollButton:null,bottomScrollButton:null,isPan:false,constructor:function(v){b.mixin(this,v);p.add(this.domNode,"custInfoWindow");var r=f.create("div",{"class":"mainDiv"},this.domNode);var u=f.create("div",{"class":"leftDiv"},r);rightDiv=f.create("div",{"class":"rightDiv"},r);var t=f.create("div",{"class":"leftArrow"},u);var s=f.create("div",{"class":"titleBarStyle"},rightDiv);this.backButton=f.create("div",{"class":"backbutton_mouseout"},s);this.contentPanel=f.create("div",{"class":"panelContentStyle"},rightDiv);this.closeButton=f.create("div",{"class":"closebutton_mouseout"},s);titlePanel=f.create("div",{id:"divTitle","class":"title"},s);toggler=new d({node:this.contentPanel,showFunc:h.wipeIn,hideFunc:h.wipeOut});toggler.show();e.hide(this.domNode);e.hide(this.backButton);m(this.closeButton,"click",b.hitch(this,function(){this.hide()}));m(this.backButton,"click",b.hitch(this,function(){if(this.backButtonObject!=null){this.backButtonObject.fun.apply(this,this.backButtonObject.data)}}));dojo.connect(this.closeButton,"onmouseout",function(w){this.className="closebutton_mouseout"});dojo.connect(this.closeButton,"onmouseover",function(w){this.className="closebutton_mouseover"});dojo.connect(this.backButton,"onmouseout",function(w){this.className="backbutton_mouseout"});dojo.connect(this.backButton,"onmouseover",function(w){this.className="backbutton_mouseover"});this.isShowing=false},hideBackButton:function(){this.backButton.style.display="none"},showBackButton:function(r){this.backButton.style.display="";this.backButtonObject=r},setMap:function(r){this.inherited(arguments);r.on("pan-start",b.hitch(this,function(s){this.isPaning=true}));r.on("pan",b.hitch(this,function(t){var s=t.delta;if(this.isShowing){if(this.showScreenPoint!=null){this._showInfoWindow(this.showScreenPoint.x+s.x,this.showScreenPoint.y+s.y)}}else{e.hide(this.domNode);e.hide(this.backButton)}}));r.on("pan-end",b.hitch(this,function(s){var t=s.delta;if(this.isShowing){this.showScreenPoint.x=this.showScreenPoint.x+t.x;this.showScreenPoint.y=this.showScreenPoint.y+t.y;this._show()}this.isPaning=false}));r.on("zoom-start",b.hitch(this,function(){e.hide(this.domNode);this.onHide()}));r.on("zoom-end",b.hitch(this,function(){if(this.isShowing){this.showScreenPoint=r.toScreen(this.showMapPoint);this._showInfoWindow(this.showScreenPoint.x,this.showScreenPoint.y)}}))},_showInfoWindow:function(r,s){k.set(this.domNode,{left:(r+12)+"px",top:(s-22)+"px"});e.show(this.domNode)},setTitle:function(r){this.place(r,titlePanel)},setContent:function(r){f.empty(this.contentPanel);this.contentPanel.style.height="auto";this.contentPanel.style.overflow="auto";this.contentPanel.style.overflowY="hidden";this.place(r,this.contentPanel);this.rePosition()},_show:function(){if(this.showMapPoint.spatialReference){this.showScreenPoint=this.map.toScreen(this.showMapPoint)}k.set(this.domNode,{left:(this.showScreenPoint.x+12)+"px",top:(this.showScreenPoint.y-22)+"px"})},show:function(r){if(r&&this.isEnabled&&!this.isPaning){this.showMapPoint=r;this._show();e.show(this.domNode);this.isShowing=true;this.onShow();j.publish("showInfoWindow",this.showMapPoint);this.rePosition()}},hide:function(){e.hide(this.domNode);this.isShowing=false;if(this.titlePanel!=null){f.empty(this.titlePanel)}if(this.contentPanel!=null){f.empty(this.contentPanel)}this.onHide();j.publish("hideInfoWindow");this.hideBackButton()},rePosition:function(){o(b.hitch(this,function(){var s={w:this.map.width,h:this.map.height};var t=n.position(this.domNode,false);t.x=parseInt(this.domNode.style.left);t.y=parseInt(this.domNode.style.top);var u=t.h;var w=Math.floor(s.h/2-50);if(w<500){w=500}if(t.h>w){t.h=w}if(t.w>0&&t.h>0){var r=(t.h+t.y)-s.h;var x=(t.w+t.x)-s.w;if(this.centerScreen==null){this.centerScreen=new c(Math.floor(s.w/2),Math.floor(s.h/2))}var z=false;if(r>0&&t.h<s.h){this.centerScreen.y+=r+20;z=true}if(x>0&&t.w<s.w){this.centerScreen.x+=x+20;z=true}if(z&&this.centerScreen!=null){var y=this.map.toMap(this.centerScreen);if(this.isPan){var v=this.map.on("pan-end",b.hitch(this,function(){this.map.centerAt(y);this.centerScreen=null;v.remove()}))}else{this.isPan=true;var v=this.map.on("pan-end",b.hitch(this,function(){this.centerScreen=null;this.isPan=false;v.remove()}));this.map.centerAt(y)}}}if(u>t.h){this.contentPanel.style.height=t.h-70+"px";this.contentPanel.style.overflow="hidden";this.contentPanel.style.overflowY="scroll"}}))},clearFeatures:function(){j.publish("clearInfoWindow")},setFeatures:function(r){if(!this.isPaning){j.publish("setInfoWindow",r)}},resize:function(s,r){k.set(desption,{width:s+"px",height:r+"px"});k.set(title,{width:s+"px"})},destroy:function(){f.destroy(this.domNode);this.closeButton=null}});return InfoWindow});