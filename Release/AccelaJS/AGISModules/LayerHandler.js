/**
 * <pre>
 * 
 *  Accela GIS
 *  BusinessHandler.js
 * 
 *  Accela, Inc.
 *  Copyright (C): 2014
 * 
 *  Description:
 * 
 *  Note
 *  Created By: Iron Tang
 *
 * <Date>       <Who>       <What>
 * 6/30/2014     Iron Tang    init
 *
 * </pre>
 */
define(["dojo/_base/declare","dojo/_base/lang","esri/symbols/PictureMarkerSymbol","esri/graphic","dojo/topic","AGISAPI/BusinessHandler","dojo/dom-construct","esri/tasks/locator","dojo/dom","dojo/query","esri/geometry/webMercatorUtils","dojo/_base/html","dojo/json","dojo/_base/array","esri/symbols/SimpleFillSymbol","esri/symbols/SimpleLineSymbol","esri/symbols/SimpleMarkerSymbol","esri/Color","esri/layers/FeatureLayer","esri/tasks/query","esri/geometry/Extent","esri/geometry/Multipoint","esri/geometry/Point","esri/SpatialReference","dojo/string","dojo/on"],function(t,z,d,p,q,j,i,g,s,h,w,l,a,c,e,b,o,y,r,n,x,f,v,m,u,k){return t(null,{map:null,locationGraphic:null,locator:new g(_globalGeocodeServerUrl),AGISTYPEKEY:"agisType",AGISPARENTKEY:"agisParent",AGISTYPELAYER:"layer",AGISTYPEFEATURE:"feature",ISSELECTION:"isSelection",SHOWMAPPOINT:"showMapPoint",AGISEXTENT:"agisExtent",locatorCache:[null,null],constructor:function(A){this.map=A;q.subscribe("setInfoWindow",z.hitch(this,function(B){if(this.map.infoWindow.isEnabled){this._showFeatures(this.getAllFeatures(B))}}))},getAllFeatures:function(E){var F=[];for(var D=0;D<E.length;D++){if(E[D]!=null&&E[D].results!=null){var C=E[D].results;for(var B=0;B<C.length;B++){if(C[B]!=null){for(var A=0;A<C[B].length;A++){if(C[B][A]!=null){F.push(C[B][A])}}}}}}return F},getIdfieldByLayer:function(C){if(C==null){return null}var D=C.objectIdField;var E=this.map.config.map.layers;for(var B=0;B<E.length;B++){if(C.name){if(E[B].name.toLowerCase()==C.name.toLowerCase()){if(E[B].fields){for(var A=0;A<E[B].fields.length;A++){if(E[B].fields[A]&&E[B].fields[A].idfield&&E[B].fields[A].idfield.toLowerCase()=="true"){D=E[B].fields[A].id;break}}}break}}}return D},getIdfieldByLayerName:function(C){var A=null;for(var D in this.map._layers){var B=this.map._layers[D];if(B.name){if(B.name.toLowerCase()==C.toLowerCase()){A=B;break}}}return this.getIdfieldByLayer(A)},setSelectionSymbol:function(C){var D=this.map.graphicsLayerIds;var B=new e(e.STYLE_SOLID,new b(b.STYLE_DASHDOT,new y([255,0,0]),2),new y([255,255,0,0.5]));var A=new o(o.STYLE_X,8,new b(b.STYLE_SOLID,new y([255,0,0,0.5]),2));dojo.forEach(D,z.hitch(this,function(E){var F=this.map.getLayer(E);if(F.type=="Feature Layer"){if(C){F.mode=r.MODE_ONDEMAND;if(F.geometryType=="esriGeometryPolygon"||F.geometryType=="esriGeometryPolyline"){F.setSelectionSymbol(B)}else{F.setSelectionSymbol(A)}}else{F.mode=null;F.setSelectionSymbol(null)}}}))},GetLayerFeatures:function(F){var G=[];G[this.ISSELECTION]=false;var E=q.subscribe("showInfoWindow",z.hitch(this,function(H){G[this.SHOWMAPPOINT]=H;E.remove()}));if(F){for(var D=0;D<F.length;D++){if(F[D]){if(F[D]._graphicsLayer){var C=F[D];var B=null;for(var A=0;A<G.length;A++){if(G[A].id==C._graphicsLayer.id){B=G[A];break}}if(B==null){B=C._graphicsLayer;B[this.AGISTYPEKEY]=this.AGISTYPELAYER;B[this.AGISPARENTKEY]=G;for(var A=0;A<this.map.config.map.layers.length;A++){if(this.map.config.map.layers[A].name.toLowerCase()==B.name.toLowerCase()){B.icon=_globalGISUrl+this.map.config.map.layers[A].icon;break}}B.features=[];B[this.AGISEXTENT]=null;B[this.SHOWMAPPOINT]=null;G.push(B)}C[this.AGISPARENTKEY]=B;C[this.AGISTYPEKEY]=this.AGISTYPEFEATURE;if(c.indexOf(B.features,C)==-1){if(C.geometry.type.toLowerCase()=="polygon"){C[this.SHOWMAPPOINT]=C.geometry.getCentroid()}else{if(C.geometry.type.toLowerCase()=="point"){C[this.SHOWMAPPOINT]=C.geometry}else{C[this.SHOWMAPPOINT]=C._extent.getCenter()}}B.features.push(C);if(!B[this.AGISEXTENT]){B[this.AGISEXTENT]=C._extent}else{B[this.AGISEXTENT]=B[this.AGISEXTENT].union(C._extent)}B[this.SHOWMAPPOINT]=B[this.AGISEXTENT].getCenter()}}}}}return G},_showFeatures:function(A){if(A&&A.length>0){var C=this.GetLayerFeatures(A);C[this.ISSELECTION]=false;this._showInfoWindow(C);var B=q.subscribe("showInfoWindow",z.hitch(this,function(D){this.AddMarker(D);B.remove()}))}},_showInfoWindow:function(B){if(this.locationGraphic!=null){this.map.graphics.remove(this.locationGraphic)}this.setSelectionSymbol(true);this.ShowInfoWindow(B);var A=q.subscribe("hideInfoWindow",z.hitch(this,function(){for(var C=0;C<B.length;C++){if(B[C]!=null){B[C].clearSelection()}}this.setSelectionSymbol(false);A.remove()}))},ShowFeatures:function(A){if(A&&A.length>0){var B=this.GetLayerFeatures(A);B[this.ISSELECTION]=true;this._showInfoWindow(B)}},ShowLocation:function(A){if(this.map.infoWindow.isEnabled){if(this.map.infoWindow.isShowing){this.map.infoWindow.hide()}this.getLocatorCache(A,null,null,null)}},AddMarker:function(A){if(this.locationGraphic!=null){this.map.graphics.remove(this.locationGraphic)}var D=new d(_globalGISUrl+"Images/icon_pin_orange.png",32,32).setOffset(0,14);this.locationGraphic=new p(A,D,null,this.map.infoWindow);k(this.map.graphics,"click",z.hitch(this,function(E){if(E.graphic==this.locationGraphic){E.preventDefault();E.stopPropagation()}}));this.map.graphics.add(this.locationGraphic);var C=q.subscribe("showInfoWindow",z.hitch(this,function(E){this.locationGraphic.setGeometry(E)}));var B=q.subscribe("hideInfoWindow",z.hitch(this,function(){this.map.graphics.remove(this.locationGraphic);this.locationGraphic=null;C.remove();B.remove()}))},ShowInfoWindow:function(A){if(A===null){return}this.ShowInfoWindowForLayer(A)},ShowInfoWindowForLayer:function(C){this.setSelectionLayers(C,null,null);var A=0;for(var B=0;B<C.length;B++){A+=C[B].features.length}this.createDomForWindow(C,A)},createDomForWindow:function(B,G){if(B!==null){var H=[];if(G==1){var D=B[0];var L=B[0].features[0];var A=this.map.layerHandler.getIdfieldByLayer(D);var K=L.attributes[A];H.push(this.creatButton(K,D.icon,z.hitch(this,function(M){this.ShowInfoWindowForGISObject(M,"LAYERS")}),[L]))}else{for(var C=0;C<B.length;C++){var D=B[C];var E=D.features.length;if(E<10){E="&nbsp;"+E+"&nbsp;"}H.push(this.creatButton(D.name+"&nbsp;&nbsp;<span class='layerCount'>"+E+"</span>",D.icon,z.hitch(this,function(M){this.ShowInfoWindowForFeature(M)}),[D],true))}}var J="What's Here?";var F="We found "+G+" GIS objects at this location. Please select an object to view details.";var I={fun:z.hitch(this,function(M){this.ShowInfoWindow(M);this.map.infoWindow.hideBackButton()}),data:[B]};this.creatPanel(J,F,H,B[this.ISSELECTION]?false:true,I)}},rightString:function(A,B){if(A.length-B>=0&&A.length>=0&&A.length-B<=A.length){return"..."+A.substring(A.length-B,A.length)}else{return A}},ShowInfoWindowForFeature:function(D){var B=D[this.AGISPARENTKEY];this.setSelectionLayers(B,D,null);var F=[];var E=0;var A=this.map.layerHandler.getIdfieldByLayer(D);for(var C=0;C<D.features.length;C++){var I=D.features[C];var H=I.attributes[A];F.push(this.creatButton(H,D.icon,z.hitch(this,function(J){this.ShowInfoWindowForGISObject(J,"LAYER")}),[I]));E++}var G={fun:z.hitch(this,function(J){this.ShowInfoWindow(J);this.map.infoWindow.hideBackButton()}),data:[B]};this.map.infoWindow.showBackButton(G);this.creatPanel("What's Here?","We found "+E+" "+D.name,F,false,null)},ShowInfoWindowForGISObject:function(E,D){var C=E[this.AGISPARENTKEY];var H=C[this.AGISPARENTKEY];this.setSelectionLayers(H,C,E);var B=null;if(D&&D.toUpperCase()=="LAYERS"){B={fun:z.hitch(this,function(I){this.ShowInfoWindow(I);this.map.infoWindow.hideBackButton()}),data:[H]}}else{if(D&&D.toUpperCase()=="LAYER"){B={fun:z.hitch(this,function(I){this.ShowInfoWindowForFeature(I)}),data:[C]}}}var A=this.map.layerHandler.getIdfieldByLayer(C);var F=E.attributes[A];this.map.infoWindow.setTitle(this.rightString(C.name+" "+F,25));this.map.infoWindow.showBackButton(B);var G=i.create("div");i.create("div",{id:"BussinessDataPanel","class":"panelDespStyle",innerHTML:"<img src='"+_globalGISUrl+"Images/themes/Blue/InfoWindows/loading.gif'></img>"},G);this.showContextMenu(E,G,true,{fun:z.hitch(this,function(I){this.ShowInfoWindowForGISObject(I,D)}),data:[E]});this.map.infoWindow.setContent(G);this.getBussinessData(E,C.name+" "+F)},setSelectionLayers:function(D,C,B){for(var A=0;A<D.length;A++){D[A].clearSelection();if(C!=null){if(D[A].id==C.id){this.setSelectionLayer(D[A],B)}}else{this.setSelectionLayer(D[A],B)}}},setSelectionLayer:function(C,B){var F=C.objectIdField;var E=new n();var D=[];if(B!=null){D=[B.attributes[F]]}else{for(var A=0;A<C.features.length;A++){D.push(C.features[A].attributes[F])}}E.objectIds=D;C.selectFeatures(E)},creatPanel:function(J,E,G,K,I){var L=i.create("div");var H=i.create("div",{"class":"titlePanelStyle",innerHTML:this.rightString(J,25)});var F=i.create("div",{"class":"panelDespStyle",innerHTML:E},L);var A=i.create("div",{"class":""},L);var B=i.create("div",{"class":""},L);if(K){locationPanel=i.create("div",{"class":""},L);if(this.map.infoWindow.isShowing){this.getLocatorCache(this.map.infoWindow.showMapPoint,H,locationPanel,I)}else{var D=q.subscribe("showInfoWindow",z.hitch(this,function(M){this.getLocatorCache(M,H,locationPanel,I);D.remove()}))}}for(var C=0;C<G.length;C++){i.place(G[C],A)}this.map.infoWindow.setTitle(H);this.map.infoWindow.setContent(L)},creatButton:function(A,G,F,J,E){var D="buttonRowStyle";if(E){D="buttonRowStyle buttonRowStyleNoBorder"}var H=i.create("div",{"class":D});var B=i.create("div",{"class":"imgContainerStyle"},H);var L=i.create("img",{"class":"panelButtonImageStyle"},B);L.src=G;var C=i.create("div",{"class":"btnContainerOutStyle"},H);var K=i.create("div",{"class":"btnContainerStyle"},C);var I=i.create("div",{"class":"btninfowindow_item_mouseout",innerHTML:A},K);dojo.connect(I,"onmouseout",function(M){this.className="btninfowindow_item_mouseout"});dojo.connect(I,"onmouseover",function(M){this.className="btninfowindow_item_mouseover"});dojo.connect(I,"onclick",z.hitch(this,function(M){F.apply(this,J)}));return H},getBussinessData:function(C,B){var D=j.getInstance(C);var A=D.getBussinessData(C);if(A){A.response.then(z.hitch(this,function(I){var N=h("#BussinessDataPanel");var L="";var H=I.data;var K=a.parse(H);K=a.parse(K);if(K&&K.Parcels instanceof Array){var E=K.Parcels[0];if(E){this.map.infoWindow.setTitle("Parcel# "+E.display);L="Parcel# "+E.display}else{L="GIS Object "+B}}else{if(K&&K instanceof Array){var M,G;if(K[0].DisplayName){M=K[0].DisplayName}else{M=K[0].Id}this.map.infoWindow.setTitle("Parcel# "+M);L="Parcel# "+M;if(K[0].Addresses&&K[0].Addresses instanceof Array){var F;for(var J=0;J<K[0].Addresses.length;J++){if(K[0].Addresses[J]){if(K[0].Addresses[J].IsPrimary){F=K[0].Addresses[J];break}}}if(!F){F=K[0].Addresses[0]}if(F){if(F.HouseNumber){G=F.HouseNumber}if(F.StreetDirection){G=G+" "+F.StreetDirection}if(F.StreetName){G=G+" "+F.StreetName}if(F.StreetSuffix){G=G+" "+F.StreetSuffix}if(F.City){G=G+" "+F.City}if(F.PostalCode){G=G+" "+F.PostalCode}}}if(G){L+="<br/>Addresses: "+G}}else{L="GIS Object "+B}}if(N){N[0].innerHTML=L}}),function(E){var F=E})}},showContextMenu:function(K,J,B,H,F){var E=K._graphicsLayer;if(!E){E=K[this.AGISPARENTKEY]}var G=this.map.layerHandler.getIdfieldByLayer(E);var I=this.map.config.map.AAGISServiceID;if(B){i.create("div",{"class":"actionTitleStyle",innerHTML:"Action Items"},J)}else{this.map.infoWindow.setTitle("Context Menu");i.create("div",{"class":"panelDespStyle",innerHTML:E.name+" "+K.attributes[G]},J)}var A=this.map.config.map.commands;for(var D=0;D<A.length;D++){if(A[D].enable.toLowerCase()=="true"){var C={command:A[D].action,mapServiceId:I,gISObjects:(F?F:[{type:E.name,key:K.attributes[G]}])};this.createCommand(A[D].title,C,K,A[D].eventtype,J,H)}}return J},createCommand:function(H,F,B,E,G,A){var C=i.create("div",{"class":"buttonRowStyle"},G);var D=i.create("div",{"class":"btninfowindow_item_mouseout",innerHTML:H},C);dojo.connect(D,"onmouseout",function(I){this.className="btninfowindow_item_mouseout"});dojo.connect(D,"onmouseover",function(I){this.className="btninfowindow_item_mouseover"});dojo.connect(D,"onclick",z.hitch(this,function(J){switch(E.toLowerCase()){case"showgisinformation":q.publish("Show-GISInformation",B);if(A!=null){this.map.infoWindow.showBackButton(A)}break;case"showservicearea":var I=null;if(B){I=B._extent.getCenter()}else{I=w.geographicToWebMercator(F.gISObjects.location)}q.publish("Show-ServiceArea",I);break}if(this.map.events!=null){for(var K=0;K<this.map.events.length;K++){if(this.map.events[K].key.toLowerCase()==E.toLowerCase()){this.map.events[K].fun({eventType:E,eventData:F});break}}}}))},getLocatorCache:function(A,G,E,D){if(this.locatorCache[0]!=null&&this.locatorCache[0].x==A.x&&this.locatorCache[0].y==A.y){this.locationComplete(this.locatorCache[1],G,E,A,D);return}var B=w.webMercatorToGeographic(A);var C=this.locator.locationToAddress(B,100,z.hitch(this,function(H){C=null;this.locatorCache=[A,H];this.locationComplete(H,G,E,A,D)}),z.hitch(this,function(I){if(window.console){console.log(I.message)}var H={address:{Address:""},location:B};this.locatorCache=[A,H];this.locationComplete(H,G,E,A,D)}));if(G==null&&E==null){var F=this.map.on("pan",z.hitch(this,function(H){if(C!=null){C.cancel()}F.remove()}))}},locationComplete:function(I,D,B,H,E){if(I.address){var F=I.address;var G=w.geographicToWebMercator(I.location);var C=Math.round(I.location.x*1000000)/1000000;var A=Math.round(I.location.y*1000000)/1000000;if(this.map.infoWindow.isShowing){if(D){D.innerHTML="<span class='locateTitle'>"+F.Address+(F.Address==""?"":"<br />")+"X: "+C+", Y: "+A+"</span>"}if(B){var J=this.createUseLocation(F,I.location,E);i.create("hr",{"class":"locationhr"},B);l.place(J,B);this.map.infoWindow.rePosition()}}else{this.showUseLocation(F,I.location,H)}}},showUseLocation:function(C,A,B){this.map.infoWindow.hideBackButton();var G=Math.round(A.x*1000000)/1000000;var H=Math.round(A.y*1000000)/1000000;var D={fun:z.hitch(this,function(K,I,J){this.showUseLocation(K,I,J)}),data:[C,A,B]};var F=this.createUseLocation(C,A,D);var E=i.create("div",{"class":"titlePanelStyle",innerHTML:"<span class='locateTitle'>"+C.Address+(C.Address==""?"":"<br />")+"X: "+G+", Y: "+H+"</span>"});this.map.infoWindow.setTitle(E);this.map.infoWindow.setContent(F);this.map.infoWindow.show(B);this.AddMarker(B)},createUseLocation:function(H,I,F){var D=Math.round(I.x*1000000)/1000000;var A=Math.round(I.y*1000000)/1000000;var K=i.create("div");i.create("div",{"class":"panelDespStyle",innerHTML:"<span class='uselocation'>Use this Location</span><br />You can use this address and/or coordinates to submit an application."},K);var E=i.create("div",{"class":"buttonUseLocationRowStyle"},K);var B=i.create("div",{"class":"imgUseLocationContainer"},E);var J=i.create("img",{"class":"useLoctionButtonImageStyle"},B);J.src=_globalGISUrl+"Images/themes/Blue/InfoWindows/icon_locat_white.png";var G=i.create("div",{"class":"panelUseLocationStyle"},E);var C=i.create("span",{"class":"useLocationDesStyle",innerHTML:"Use Location"},G);dojo.connect(E,"onmouseout",function(L){this.className="buttonUseLocationRowStyle"});dojo.connect(E,"onmouseover",function(L){this.className="buttonUseLocationRowStyle_mouseover"});dojo.connect(E,"onclick",z.hitch(this,function(L){for(var N in this.map._layers){var M=this.map._layers[N];if(M&&M.capabilities&&M.capabilities.toLowerCase()=="query"){M.clearSelection()}}this.showLocateCommand(H,I,F)}));return K},FormatAddress:function(B){if(B&&B.Address){var A=B.Address.split(" ");if(A){if(this.IsNum(A[0])){B.HouseNumber=A[0];B.StreetName=B.Address.substring(A[0].length+1,B.Address.length);if(A.length==3){B.StreetSuffix=A[2];B.StreetName=A[1]}else{if(A.length>3){B.StreetDirection=A[1];B.StreetSuffix=B.Address.substring(A[0].length+A[1].length+2,B.Address.length);B.StreetName=A[2]}}}}}return B},ContainDirection:function(A){var B=["E","N","NE","NW","S","SE","SW","W"];c.forEach(A,function(C){c.forEach(B,function(D){if(C===D){return true}})});return false},IsNum:function(C){if(C!=null){var B;var A=/^\d+$/;B=C.match(A);return(B==C)?true:false}return false},showLocateCommand:function(H,I,G){var C=this.FormatAddress(H);var F=Math.round(I.x*1000000)/1000000;var A=Math.round(I.y*1000000)/1000000;var J=i.create("div");i.create("div",{"class":"panelDespStyle",innerHTML:H.Address+(H.Address==""?"":"<br />")+"X: "+F+", Y: "+A},J);var B=this.map.config.map.commands;for(var E=0;E<B.length;E++){if(B[E].enable.toLowerCase()=="true"){if(B[E].action.toUpperCase()=="CREATE_CAP"||B[E].action.toUpperCase()=="SERVICE_REQUEST"||B[E].action.toUpperCase()=="SHOW_SERVICE_AREA"){var D={command:B[E].action,isUseLocation:true,mapServiceId:this.map.config.map.AAGISServiceID,gISObjects:{address:C,location:I,x:F,y:A}};this.createCommand(B[E].title,D,null,B[E].eventtype,J,G)}}}this.map.infoWindow.setTitle("Use this Location");this.map.infoWindow.setContent(J);this.map.infoWindow.showBackButton(G)},showExtentView:function(C){if(C&&C.length>0){var B=new f(C[0].spatialReference);for(var A=0;A<C.length;A++){B.addPoint(new v(C[A].xmin,C[A].ymin));B.addPoint(new v(C[A].xmax,C[A].ymax))}this.showMultipointView(B)}},showPointsView:function(B){if(B&&B.length>0){var C=new f(B[0].spatialReference);for(var A=0;A<B.length;A++){C.addPoint(B[A])}this.showMultipointView(C)}},showMultipointView:function(B){var A=B.getExtent();this.map.setExtent(A,true)}})});