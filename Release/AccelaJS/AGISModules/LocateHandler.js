/**
 * <pre>
 * 
 *  Accela GIS
 *  BusinessHandler.js
 * 
 *  Accela, Inc.
 *  Copyright (C): 2014
 * 
 *  Description:
 * 
 *  Note
 *  Created By: Iron Tang
 *
 * <Date>       <Who>       <What>
 * 6/30/2014     Iron Tang    init
 *
 * </pre>
 */
define(["AGISAPI/Map","AGISAPI/Controls/AGPicturemarkerSymbol","dojo/_base/declare","dojo/_base/lang","dojo/topic","dojo/Deferred","dojo/_base/array","dojo/on","dojo/json","dojo/request","dojo/query","dojo/_base/event","esri/graphic","esri/layers/GraphicsLayer","esri/symbols/PictureMarkerSymbol","esri/symbols/TextSymbol","esri/symbols/Font","esri/SpatialReference","esri/tasks/locator","esri/geometry/webMercatorUtils","esri/geometry/Extent","esri/tasks/query","esri/tasks/QueryTask","dojo/dom-construct","dojo/promise/all","dojo/dom"],function(c,q,A,E,t,a,i,k,y,e,h,u,r,s,f,p,x,l,o,C,D,n,b,g,d,w){var z=null,j,m,B,v;v=A(null,{map:null,locator:null,locateInfo:null,loadedConfigData1:null,extentList:[],graphicsLayerList:[],previousGraphicLayer:null,previousObject:null,hasLocatedItem:false,minX:null,minY:null,maxX:null,maxY:null,constructor:function(F){this.loadedConfigData=F.config;this.map=F},locateData:function(F){this.locateInfo=F;this.locate();if(this.locateInfo.GraphicLayerID!=undefined){this.enlargeIcon(this.locateInfo.GraphicLayerID)}},locate:function(){var K=this.map;var J=[];var G=new a();if(this.locateInfo!==null&&this.locateInfo.GraphicLayerID==undefined){this.map.infoWindow.hide();if(B&&B.length){for(var I=0;I<B.length;I++){this.map.removeLayer(B[I])}}this.graphicsLayerList=[];B=null;if(this.locateInfo.addresses&&this.locateInfo.addresses.length>0){J.push(this.locateAddress(this.locateInfo.addresses,K))}if(this.locateInfo.records&&this.locateInfo.records.length>0){J.push(this.locateGISRecords(this.locateInfo.records,K))}this.extentList=[];if(this.locateInfo&&this.locateInfo.parcels&&this.locateInfo.parcels.length>0){this.locateInfo.AAGISServiceId=this.loadedConfigData.map.AAGISServiceID;this.locateInfo.AAUserName=this.loadedConfigData.map.AAUserName;this.locateInfo.AAPassword=this.loadedConfigData.map.AAPassword;this.locateInfo.AppServerURL=this.loadedConfigData.map.AppServerURL;var F=y.stringify(this.locateInfo);var H=e.post(_globalGISUrl+"api/QueryParcel",{data:F,headers:{"content-type":"application/json",Accept:"application/json"},handAs:"json"});J.push(G);H.response.then(E.hitch(this,function(O){var N=[];var L=O.data;var S=y.parse(L);S=y.parse(S);for(var P in S){for(var M in S[P].GISObjects){if(S[P].Addresses.length>0){var R=false;for(var Q=0;Q<S[P].Addresses.length;Q++){if(S[P].Addresses[Q].IsPrimary==true){N.push(this.locateParcels(S[P].GISObjects[M],S[P].Id,K,S[P].Addresses[Q]));R=true}}if(R==false&&S[P].Addresses.length>0){N.push(this.locateParcels(S[P].GISObjects[M],S[P].Id,K,S[P].Addresses[0]))}}else{N.push(this.locateParcels(S[P].GISObjects[M],S[P].Id,K,S[P].Addresses))}}if(S[P].GISObjects==null&&S[P].Addresses&&S[P].Addresses.length>0){N.push(this.locateAddress(S[P].Addresses,K,S[P].Id))}}if(S){d(N).then(E.hitch(this,function(T){G.resolve(T)}))}else{G.resolve(false)}}))}d(J).then(E.hitch(this,function(L){if(L){var N;var M=this.calculateExtent(L,N);if(M){this.map.balloonExtent=M;this.map.setExtent(M,true)}else{this.alertMsg("The map cannot locate any item.",0)}}}))}},calculateExtent:function(F,G){if(F instanceof Array&&F.length>0){i.forEach(F,E.hitch(this,function(H){if(H&&H instanceof Array){G=this.calculateExtent(H,G)}else{G=this.composeExtent(H,G)}}))}else{G=this.composeExtent(F,G)}return G},comparePntAndExtent:function(G,F){if(G.xmin>F.x){G.xmin=F.x}if(G.xmax<F.x){G.xmax=F.x}if(G.ymin>F.y){G.ymin=F.y}if(G.ymax<F.y){G.ymax=F.y}return G},enlargeIcon:function(O){var I=this.map._layers;var S=[];var V=[];var M=[];var N=[];for(var F in I){var K=I[F];if(K.graphics!=undefined&&K.graphics[0]!=undefined){if(K.id.indexOf(O.id)>=0){HightLightlayer=K;S.push(HightLightlayer);N.push(K);var Q="";if(K.id.split("_").length>1){for(var H=1;H<K.id.split("_").length;H++){if(H==K.id.split("_").length-1){Q+=K.id.split("_")[H]}else{Q+=K.id.split("_")[H]+"_"}}}if(K.id==O.id){M.push(K.id)}if(Q!=""){M.push(Q)}}}if(this.previousObject!=null){if(K.id&&K.id.indexOf(this.previousObject)>=0){V.push(K)}}}if(S.length>0){this.previousObject=O.id;var P=[];var J=S[0].graphics[0].symbol.height;if(!O.isEnlarge){for(var H=0;H<S.length;H++){S[H].graphics[0].symbol.url=_globalGISUrl+"Images/icon_pin_blue.png";S[H].graphics[0].symbol.height=32;S[H].graphics[0].symbol.width=32;S[H].graphics[0].symbol.yoffset=15;S[H].graphics[0].draw();this.map.infoWindow.hide()}}else{this.map.infoWindow.hide();for(var H=0;H<S.length;H++){S[H].graphics[0].symbol.url=_globalGISUrl+"Images/icon_pin_yellow_@2x.png";S[H].graphics[0].symbol.height=48;S[H].graphics[0].symbol.width=48;S[H].graphics[0].symbol.yoffset=25;S[H].graphics[0].draw();P.push(S[H].graphics[0]._extent);var L=t.subscribe("hideInfoWindow",E.hitch(this,function(){for(var W=0;W<S.length;W++){S[W].graphics[0].symbol.url=_globalGISUrl+"Images/icon_pin_blue.png";S[W].graphics[0].symbol.height=32;S[W].graphics[0].symbol.width=32;S[W].graphics[0].symbol.yoffset=15;S[W].graphics[0].draw();L.remove()}}))}for(var H=0;H<N.length;H++){P.push(N[H].graphics[0]._extent)}if(P.length>0){var R;var U=this.calculateExtent(P,R);var T=this.map.balloonExtent;var G=this.IsContainExtent(U,this.map.extent);if(G){this.map.setExtent(T,true)}}}}if(S.length==0){for(var H=0;H<V.length;H++){V[H].graphics[0].symbol.url=_globalGISUrl+"Images/icon_pin_blue.png";V[H].graphics[0].symbol.height=32;V[H].graphics[0].symbol.width=32;V[H].graphics[0].symbol.yoffset=15;V[H].graphics[0].draw()}this.map.infoWindow.hide();if(O.isEnlarge==true){this.hideInfoWindowEvent();this.alertMsg("This map can not locate this item.",0)}}},IsContainExtent:function(H,F){var G=false;if(H&&F){if(H.xmin<F.xmin){G=true}if(H.ymin<F.ymin){G=true}if(H.xmax>F.xmax){G=true}if(H.ymax>F.ymax){G=true}}return G},composeExtent:function(F,G){if(F){if(G){if(F.type==="point"){G=this.comparePntAndExtent(G,F)}else{if(F.type==="extent"){G=this.compareExtentAndExtent(F,G)}}}else{if(F.type==="point"){G=new D();G.xmin=F.x;G.xmax=F.x;G.ymin=F.y;G.ymax=F.y;G.spatialReference.wkid="102100"}else{if(F.type==="extent"){G=F}}}}return G},compareExtentAndExtent:function(G,F){if(G.xmin>F.xmin){G.xmin=F.xmin}if(G.xmax<F.xmax){G.xmax=F.xmax}if(G.ymin>F.ymin){G.ymin=F.ymin}if(G.ymax<F.ymax){G.ymax=F.ymax}return G},locateParcels:function(M,O,F,I){var G=new a();var N;var J;var H;if(I&&I.length>0){for(var T in I){if(I[T]){if(I[T].IsPrimary){H=I[T].address;break}}}if(!H){H=I[0].address}}else{H=I}for(var R in this.map._layers){var K=this.map._layers[R];if(K.name){if(K.name==M.Type||K.name==M.Layer){N=K.graphics;J=K;break}}}if(J==undefined){G.resolve(false);return}var Q=this.map.layerHandler.getIdfieldByLayer(J);var S=new b(J.url);var P=new n();var L=[];P.returnGeometry=true;P.outFields=[Q];var V=M.Id;if(V==undefined){V=M.GISID}var U=J.name+"_"+V;P.where=Q+" = '"+V+"'";S.execute(P,E.hitch(this,function(Y){var ab=[];var W=Y.features.length;if(W==0){if(H){var aa=[];aa.push(H);L.push(this.locateAddress(aa,F,O));d(L).then(E.hitch(this,function(ac){G.resolve(ac)}));return}else{G.resolve(false);return}}Y.features[0]["FeatureLayer"]=J;var Z=[];for(var X=0;X<W;X++){this.HighLightGeometry(Y.features[X],U);this.PictureMarker(Y.features[X],(X+1).toString(),V,M,O,H);Z.push(Y.features[X].geometry.getExtent());this.extentList.push(Y.features[X].geometry.getExtent())}G.resolve(Z)}),function(W){G.resolve(false)});return G.promise},locateGISFeatures:function(F,J){if(parcelsInfo.layer.graphics){for(var G=0;G<arcelsInfo.layer.graphics.length;G++){var L=arcelsInfo.layer.graphics[G];if(L.attributes){var K=L.geometry;var I=F.field;var H=F.searchFieldValue;if(L.attributes[I]==H){this.HighLightGeometry(L);break}}}}},locateGISRecords:function(F,J){var H=[];var I=new a();var G;if(this.loadedConfigData!==undefined){G=new o(this.loadedConfigData.map.GeocodingService);this.locator=G;i.forEach(F,E.hitch(this,function(N){if(N.location){H.push(this.locateAddressByLocation(N.location,J))}if(N.record_by_GISObject&&N.record_by_GISObject.length>0){for(var O in N.record_by_GISObject){var L=N.id.split(",")[0]+"_"+N.record_by_GISObject[O].GISID;H.push(this.locateParcels(N.record_by_GISObject[O],L,J))}}if(N.record_by_pacerl&&N.record_by_pacerl.length>0){for(var O in N.record_by_pacerl){var L=N.id.split(",")[0]+"_"+N.record_by_pacerl[O].GISID;H.push(this.locateParcels(N.record_by_pacerl[O],L,J))}}else{if(N.CAP_Parcel_Item_address&&N.CAP_Parcel_Item_address.length>0){var M=N.CAP_Parcel_Item_address.length;for(var K=0;K<M;K++){H.push(this.locateAddressByAttributes(N.CAP_Parcel_Item_address[K].address,J))}}else{if(N.record_by_address&&N.record_by_address.length>0){for(var O in N.record_by_address){H.push(this.locateAddressByAttributes(N.record_by_address[O].address,J,N))}}else{if(N.CAP_Parcel_Item&&N.CAP_Parcel_Item.length>0){H.push(this.locateParcels(N.CAP_Parcel_Item[0],N.id,J))}}}}}))}d(H).then(function(K){I.resolve(K)});return I.promise},locateAddress:function(G,K,F){var I=[];var J=new a();var H;if(this.loadedConfigData!==undefined){H=new o(this.loadedConfigData.map.GeocodingService);this.locator=H;E.hitch(this,this.BindLocateEvent(K,H,G,F));i.forEach(G,E.hitch(this,function(M){if(M.location){I.push(this.locateAddressByLocation(M.location,K,G,F))}else{if(M.attributes){I.push(this.locateAddressByAttributes(M.attributes,K,G,F))}else{if(M.XCoordinate){var L=M.XCoordinate;var P=M.YCoordinate;var N={wkid:4326};var O={x:L,y:P,spatialReference:N};I.push(this.locateAddressByLocation(O,K,G,F))}else{I.push(this.locateAddressByAttributes(M,K,G,F))}}}}))}d(I).then(function(L){J.resolve(L)});return J},onAddressCandidateHandle:function(F,J,K,L){if(J&&J.location){var H=new f(_globalGISUrl+"Images/icon_pin_blue.png",32,32).setOffset(0,15);var M=C.geographicToWebMercator(J.location);var G=new r(M,H,J.attributes);var I=new s();I.add(G);var N;if(K instanceof Array){N=K[0]}else{N=K}if(N.record_by_address){this.bindRecordGraphicEvent(F,J,I,N,M);F.addLayer(I)}else{if(N.CAP_Parcel_Item_address){this.bindRecordGraphicEvent(F,J,I,N,M);F.addLayer(I)}else{if(N.location){if(J&&J.address){I.id=J.address.Address}this.bindGraphicEvent(F,J,I);F.addLayer(I)}else{if(N.attributes){if(J&&J.address){I.id=J.address}this.bindGraphicEvent(F,J,I);F.addLayer(I)}else{if(J&&J.address){if(J.address.City){I.id=L+"_"+J.address.Address}else{I.id=L+"_"+J.address}}this.bindRecordGraphicEvent(F,J,I,N,M,L);F.addLayer(I)}}}}this.graphicsLayerList.push(I);B=this.graphicsLayerList}},bindGraphicEvent:function(I,G,H){if(H){var F={};F.address={Address:G.address};F.location=G.location;F.graphicLayer=H;H.on("click",E.hitch(this,function(K){K.preventDefault();K.stopPropagation();this.map.infoWindow.hideBackButton();this.map.infoWindow.hide();this.ChangePictureMarker(H);previousGraphicLayer=H;var L=Math.round(F.location.x*1000000)/1000000;var M=Math.round(F.location.y*1000000)/1000000;var J=C.geographicToWebMercator(F.location);if(F.address.Address.City){this.map.layerHandler.showLocateCommand(F.address.Address,F.location,null);this.map.infoWindow.show(J);this.SendOjectID({type:"Address",typeID:F.address.Address})}else{this.map.layerHandler.showLocateCommand(F.address,F.location,null);this.map.infoWindow.show(J);this.SendOjectID({type:"Address",typeID:F.address})}}))}},bindRecordGraphicEvent:function(L,I,K,H,J,G){if(K){var F={};F.address=I.address;F.location=I.location;F.graphicLayer=K;if(H.record_by_address||H.CAP_Parcel_Item_address){F.graphicLayer.id=H.id+"_"+I.address}F.graphicLayer.name=K.name;K.on("click",E.hitch(this,function(M){M.preventDefault();M.stopPropagation();this.map.infoWindow.hide();this.ChangePictureMarker(K);previousGraphicLayer=K;this.BackbindRecordGraphicEvent(L,I,K,H,J,G);if(H.id){this.SendOjectID({type:"Record",typeID:H.id})}else{this.SendOjectID({type:"Parcel",typeID:G})}}))}},BackbindRecordGraphicEvent:function(F,K,J,P,O,N){this.map.infoWindow.hideBackButton();this.map.infoWindow.clearFeatures();var M;if(P.record_by_address&&P.record_by_address.length>0){M=P.id.split(",")[0]}else{if(P.CAP_Parcel_Item_address&&P.CAP_Parcel_Item_address.length>0){M=P.id.split(",")[0]}else{M=N}}this.map.infoWindow.setContent(M);if(P.record_by_address||P.CAP_Parcel_Item_address){this.map.infoWindow.setTitle("Record# "+M)}else{this.map.infoWindow.setTitle("Parcel# "+M)}var R=g.create("div");var G;if(P.record_by_address||P.CAP_Parcel_Item_address){if(K.address.City){G=K.address.Address}else{if(K.RecordAddress&&K.RecordAddress.Address){G=K.RecordAddress.Address}else{G=K.address}}}else{var I="";if(P.HouseNumber){I+=P.HouseNumber}if(P.Direction){I+=" "+P.Direction}if(P.StreetName){I+=" "+P.StreetName}if(P.StreetSuffix){I+=" "+P.StreetSuffix}if(P.StreetSuffixDirection){I+=" "+P.StreetSuffixDirection}if(P.City){I+=" "+P.City}if(P.State){I+=" "+P.State}if(P.PostalCode){I+=" "+P.PostalCode}G=I}g.create("div",{"class":"panelDespStyle",innerHTML:"Address: "+G},R);if(P.length>0){var L=[{type:"Record",key:M}]}else{if(K.address.City){var H=this.FormatAddress(K.address,K.address.Address);var L=[{type:"Address",key:H}]}else{var Q=this.FormatAddressCandidaeObj(K);var L=[{type:"Address",key:Q}]}}this.map.layerHandler.showContextMenu(J.graphics[0],R,true,{fun:E.hitch(this,function(W,U,V,T,S){this.BackbindRecordGraphicEvent(W,U,V,T,S)}),data:[F,K,J,P,O]},L);this.map.infoWindow.setContent(R);this.map.infoWindow.show(O);this.hideInfoWindowEvent()},FormatAddressCandidaeObj:function(G){var I;if(G){var F=G.attributes;var H=G.address;I=this.FormatAddressLine(F,H)}return I},FormatAddressLine:function(F,G){if(G){var H=G.split(",");if(H&&H.length>0){var I=H[0];F=this.FormatAddress(F,I)}}return F},FormatAddress:function(G,H){if(G&&H){var F=H.split(" ");if(F){if(this.IsNum(F[0])){G.HouseNumber=F[0];G.StreetName=H.substring(F[0].length+1,H.length);if(F.length==3){G.StreetSuffix=F[2];G.StreetName=F[1]}else{if(F.length>3){G.StreetDirection=F[1];G.StreetSuffix=H.substring(F[0].length+F[1].length+2,H.length);G.StreetName=F[2]}}}}}return G},ContainDirection:function(F){var G=["E","N","NE","NW","S","SE","SW","W"];drray.forEach(F,function(H){drray.forEach(G,function(I){if(H===I){return true}})});return false},IsNum:function(H){if(H!=null){var G;var F=/^\d+$/;G=H.match(F);return(G==H)?true:false}return false},hideInfoWindowEvent:function(){var F=t.subscribe("hideInfoWindow",E.hitch(this,function(){if(this.map.events!=null){for(var G=0;G<this.map.events.length;G++){if(this.map.events[G].key.toLowerCase()=="enlargefeatureid"){this.map.events[G].fun({type:"Record",typeID:null})}}}F.remove()}))},singleClickLister:function(F){this.map.infoWindow.rewriteSetFeatures([F.graphic])},showExtent:function(G){if(this.minX&&this.minY&&this.maxX&&this.maxY){var F=new D(this.minX,this.minY,this.maxX,this.maxY,new l({wkid:4326}));G.setExtent(C.geographicToWebMercator(F))}},BindLocateEvent:function(H,F,I,G){},getHighestScoreAddress:function(F){var G=null;var H=0;i.forEach(F,function(I){if(I.score>H){G=I;H=I.score}});return G},locateAddressByLocation:function(H,K,I,G){var L=new a();K.graphics.clear();var J={address:H,outFields:["*"]};var F=new esri.geometry.Point(H.x,H.y);this.locator.locationToAddress(F,100,E.hitch(this,function(M){this.onAddressCandidateHandle(K,M,I,G);var N={};if(M){N=this.calculateAddressExtent(M)}L.resolve(N)}),function(M){L.resolve(false)});return L.promise},locateAddressByAttributes:function(O,F,K,L){var G=new a();if(O){var I={};if(L==undefined){for(var H in O){I[H]=O[H]}var P={address:I,outFields:["*"]}}else{var J="";if(O.HouseNumber){J+=O.HouseNumber}if(O.Direction){J+=" "+O.Direction}if(O.StreetName){J+=" "+O.StreetName}if(O.StreetSuffix){J+=" "+O.StreetSuffix}if(O.StreetSuffixDirection){J+=" "+O.StreetSuffixDirection}if(O.City){J+=" "+O.City}if(O.State){J+=" "+O.State}if(O.PostalCode){J+=" "+O.PostalCode}var N=O.HouseNumber+" "+O.StreetName+" "+O.StreetSuffix+" "+O.StreetSuffixDirection+","+O.City+","+O.State+" "+O.PostalCode;var M={SingleLine:J};var P={address:M,outFields:["*"]}}this.locator.addressToLocations(P,E.hitch(this,function(Q){var R={};if(Q&&Q instanceof Array&&Q.length>0){R=this.calculateAddressExtent(Q[0]);if(O.Address){Q[0]["RecordAddress"]=O}}this.onAddressCandidateHandle(F,Q[0],K,L);G.resolve(R)}),function(Q){G.resolve(false)})}else{G.resolve(false)}return G.promise},calculateAddressExtent:function(F){var H={};if(F){var G=new D();if(F.extent){G.xmin=F.extent.xmin;G.ymin=F.extent.ymin;G.xmax=F.extent.xmax;G.ymax=F.extent.ymax;G.spatialReference=new l(102100);H=C.geographicToWebMercator(G)}else{if(F.location){H=C.geographicToWebMercator(F.location)}}}return H},bindParcelsGraphicEvent:function(G,L,I,H,K,F,J){if(L){L.on("click",E.hitch(this,function(M){M.preventDefault();M.stopPropagation();this.map.infoWindow.hide();this.ChangePictureMarker(L);previousGraphicLayer=L;this.BackbindParcelsGraphicEvent(G,L,I,H,K,F,J)}))}},BackbindParcelsGraphicEvent:function(J,L,I,O,F,G,S){var M="";this.map.infoWindow.hideBackButton();this.map.infoWindow.clearFeatures();var T=g.create("div");var H=O.Type;if(H==undefined){H=O.Layer}var R,K,Q,P;if(O.record!=undefined||O.IdentifierDisplay!=undefined){Q=O.Layer;P=O.GISID;R="Record";K=F.split("_")[0];this.map.infoWindow.setTitle(R+"# "+K)}else{R="Parcel";K=F;Q=O.Type;P=O.Id;this.map.infoWindow.setTitle(R+"# "+F)}if(G){if(G.HouseNumber){M+=G.HouseNumber}if(G.Direction){M+=" "+G.Direction}if(G.StreetName){M+=" "+G.StreetName}if(G.StreetSuffix){M+=" "+G.StreetSuffix}if(G.City){M+=" "+G.City}if(G.State){M+=" "+G.State}if(G.PostalCode){M+=" "+G.PostalCode}if(M!=""){M="<br/>Addresses:&nbsp;"+M}}g.create("div",{"class":"panelDespStyle",innerHTML:H+"#&nbsp;"+I+M},T);var N=[{type:Q,key:P}];this.map.layerHandler.showContextMenu(J,T,true,{fun:E.hitch(this,function(V,Z,X,W,Y,U){this.BackbindParcelsGraphicEvent(V,Z,X,W,Y,U)}),data:[J,L,I,O,F,S]},N);this.map.infoWindow.setContent(T);this.map.infoWindow.show(S);this.hideInfoWindowEvent();this.SendOjectID({type:R,typeID:K})},ChangePictureMarker:function(G){if(this.previousGraphicLayer!=null&&G.id!=this.previousGraphicLayer.id){previousGraphicLayer.graphics[0].symbol.url=_globalGISUrl+"Images/icon_pin_blue.png";previousGraphicLayer.graphics[0].symbol.height=32;previousGraphicLayer.graphics[0].symbol.width=32;previousGraphicLayer.graphics[0].symbol.yoffset=15;previousGraphicLayer.graphics[0].draw()}G.graphics[0].symbol.url=_globalGISUrl+"Images/icon_pin_yellow_@2x.png";G.graphics[0].symbol.height=48;G.graphics[0].symbol.width=48;G.graphics[0].symbol.yoffset=25;G.graphics[0].draw();var F=t.subscribe("hideInfoWindow",E.hitch(this,function(){G.graphics[0].symbol.url=_globalGISUrl+"Images/icon_pin_blue.png";G.graphics[0].symbol.height=32;G.graphics[0].symbol.width=32;G.graphics[0].symbol.yoffset=15;G.graphics[0].draw();F.remove()}))},PictureMarker:function(M,K,I,R,L,J){var F=M.geometry.getExtent().getCenter();var Q=new esri.geometry.Point(F.x,F.y);Q.spatialReference=M.geometry.spatialReference;var H=new f(_globalGISUrl+"Images/icon_pin_blue.png",32,32).setOffset(0,15);var G=new r(Q,H,M.attributes);var O=new s();O.add(G);O.url="PicIcon";O.id=L;var P=false;for(var N=0;N<this.graphicsLayerList.length;N++){if(this.graphicsLayerList[N].id==L){P=true}}if(P==false){this.graphicsLayerList.push(O);B=this.graphicsLayerList;this.map.addLayer(O)}B=this.graphicsLayerList;this.hasLocatedItem=true;this.bindParcelsGraphicEvent(M,O,I,R,L,J,Q)},SendOjectID:function(G){if(this.map.events!=null){for(var F=0;F<this.map.events.length;F++){if(this.map.events[F].key.toLowerCase()=="enlargefeatureid"){if(G.typeID.Address){this.map.events[F].fun({type:G.type,typeID:G.typeID.Address})}else{if(G.typeID.indexOf("_")>=0){this.map.events[F].fun({type:G.type,typeID:G.typeID.split("_")[0]})}else{if(G.typeID.indexOf(",")>=0){this.map.events[F].fun({type:G.type,typeID:G.typeID.split(",")[0]})}else{this.map.events[F].fun({type:G.type,typeID:G.typeID})}}}break}}}},NumberMarker:function(K,G){var J=new f(_globalGISUrl+"Images/icon_marker_purple.png",32,32).setOffset(0,30);var I=new r(K,J,"");var H=new s();H.add(I);var F=new p(G).setColor(new esri.Color("#888")).setOffset(0,27).setFont(new x("12pt").setWeight(x.WEIGHT_BOLD));H.add(new r(K,F,""));this.map.addLayer(H)},HighLightGeometry:function(H,K){this.map.graphics.clear();var G=H.geometry;if(H.geometry){switch(G.type){case"point":var F=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_SQUARE,15,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([0,0,255]),2),new dojo.Color([255,0,0,0.25]));var M=new esri.geometry.Point();M.x=G.x;M.y=G.y;this.map.centerAt(M);break;case"polyline":var F=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([223,96,226]),2);H.setSymbol(F);var N=G.getExtent();this.map.setExtent(N);var J=new s();J.add(H);J.id=K;var L=false;for(var I=0;I<this.graphicsLayerList.length;I++){if(this.graphicsLayerList[I].id==K){L=true}}if(L==false){this.graphicsLayerList.push(J);B=this.graphicsLayerList;this.map.addLayer(J)}break;case"polygon":var F=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([223,96,226]),3),new dojo.Color([223,96,226,0.5]));H.setSymbol(F);var N=G.getExtent();var J=new s();J.add(H);J.id=K;var L=false;for(var I=0;I<this.graphicsLayerList.length;I++){if(this.graphicsLayerList[I].id==K){L=true}}if(L==false){this.graphicsLayerList.push(J);B=this.graphicsLayerList;this.map.addLayer(J)}break}}},alertMsg:function(G,M){G=G||"";M=M||0;var Q=document.body.scrollTop||document.documentElement.scrollTop;var S=(document.all)?true:false;var K=S&&!window.XMLHttpRequest;var R=document.documentElement.scrollTop||document.body.scrollTop;var P=document.documentElement.scrollLeft||document.body.scrollLeft;var N=function(){var Y,U,W,Z,V,X;if(window.innerHeight&&window.scrollMaxY){Y=document.body.scrollWidth;U=window.innerHeight+window.scrollMaxY}else{if(document.body.scrollHeight>document.body.offsetHeight){Y=document.body.scrollWidth;U=document.body.scrollHeight}else{Y=document.body.offsetWidth;U=document.body.offsetHeight}}if(self.innerHeight){W=self.innerWidth;Z=self.innerHeight}else{if(document.documentElement&&document.documentElement.clientHeight){W=document.documentElement.clientWidth;Z=document.documentElement.clientHeight}else{if(document.body){W=document.body.clientWidth;Z=document.body.clientHeight}}}if(U<Z){X=Z}else{X=U}if(Y<W){V=W}else{V=Y}return{pageWidth:V,pageHeight:X,windowWidth:W,windowHeight:Z}}();var I="opacity:0.8;top:0;left:0;position:absolute;z-index:10000;background:#666;width:"+N.pageWidth+"px;height:"+(N.pageHeight+30)+"px;";var T=document.createElement("div");T.style.cssText=I;T.id="shadowDiv";document.body.insertBefore(T,document.body.firstChild);var O="display:block;position:fixed;_position:absolute;left:"+(N.windowWidth/2-160)+"px;top:"+(N.windowHeight/2-150)+"px;_top:"+(N.windowHeight/2+Q-150)+"px;";var L=document.createElement("div");L.id="alertMsg";L.style.cssText=O;var J=document.createElement("P");J.id="alertMsg_info";J.innerHTML=G;L.appendChild(J);var H=document.createElement("a");H.id="alertMsg_btn1";H.href="javascript:void(0)";H.innerHTML="<cite>OK</cite>";H.onclick=function(){document.body.removeChild(L);document.body.removeChild(T);return true};L.appendChild(H);if(M===1){var F=document.createElement("a");F.id="alertMsg_btn2";F.href="javascript:void(0)";F.innerHTML="<cite>Cancel</cite>";F.onclick=function(){document.body.removeChild(L);document.body.removeChild(T);return false};L.appendChild(F)}document.body.appendChild(L);dojo.connect(w.byId("alertMsg_btn1"),"onmouseover",function(U){h("#alertMsg_btn1").style("background-color","#f48830")});dojo.connect(w.byId("alertMsg_btn1"),"onmouseout",function(U){h("#alertMsg_btn1").style("background-color","black")})}});return v});